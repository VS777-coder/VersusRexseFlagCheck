<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Versus Revise - 9 Symbols View</title>
    <style>
        :root { --c-bg: #111; --c-text: #eee; --c-accent: #ffd700; }
        
        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        html, body { 
            width: 100%; height: 100%; 
            min-height: 100dvh; 
            margin: 0; padding: 0; 
            background: var(--c-bg); color: var(--c-text); 
            font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; 
            overflow: hidden; 
            display: flex; flex-direction: column;
            
            touch-action: manipulation; 
            overscroll-behavior: none;  
            -webkit-text-size-adjust: 100%;
        }
        
        /* 上部操作パネル */
        .controls { padding: 4px; flex-shrink: 0; background: #222; border-bottom: 1px solid #444; z-index: 20; }
        .tab-group { display: flex; gap: 4px; margin-bottom: 4px; overflow-x: auto; }
        .tab { flex: 1; padding: 10px 4px; text-align: center; font-size: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; border: 1px solid #444; opacity: 0.5; transition: all 0.2s; white-space: nowrap; min-width: 60px; color: #aaa; background: #1a1a1a; }
        .tab.active { opacity: 1; border-color: #888; box-shadow: 0 0 5px rgba(255,255,255,0.2); color: #fff; }
        
        .stop-tab.active#t-left { background: #ffb7ce; color: #800020; border-color: #ff80ab; }
        .stop-tab.active#t-middle { background: #b3e5fc; color: #003c8f; border-color: #80d8ff; }
        .stop-tab.active#t-right { background: #c8e6c9; color: #1b5e20; border-color: #69f0ae; }
        
        .state-tab#s-bonus_unestablished.active { background: #fff; color: #000; }
        .state-tab#s-x_big_established.active { background: #304ffe; color: #fff; }
        .state-tab#s-seven_big_established.active { background: #d50000; color: #fff; }
        .state-tab#s-reg_bonus_established.active { background: #222; color: #fff; border: 1px solid #fff; }

        /* メインエリア：左リスト、右リール */
        .workspace { 
            display: flex; 
            flex-direction: row-reverse; 
            flex: 1; 
            overflow: hidden; 
            padding: 8px; 
            gap: 8px; 
            align-items: flex-start; 
            justify-content: center;
            background: #000;
        }
        
        /* リールコンテナ：9コマ表示 (60px * 9 = 540px) */
        .reel-container { 
            width: 100px; 
            height: 540px; /* 9コマ分 */
            position: relative; 
            background: #000; 
            border: 2px solid #333; 
            border-radius: 6px; 
            flex-shrink: 0; 
            overflow: hidden; 
            touch-action: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        
        .reel-strip { position: absolute; width: 100%; top: 0; left: 0; will-change: transform; }
        
        .symbol { height: 60px; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.15); position: relative; font-size: 10px; box-sizing: border-box; }
        
        .sym-idx { 
            width: 28px; 
            flex-shrink: 0;
            text-align: center; 
            color: var(--c-accent); 
            font-weight: bold; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #111; 
            border-right: 1px solid #333;
            z-index: 2; 
            font-size: 12px; 
        }
        
        .sym-bg { 
            position: absolute; 
            top: 0; 
            left: 28px; 
            right: 0; 
            bottom: 0; 
            z-index: 1; 
            background-color: #000; 
            background-repeat: no-repeat;
            background-position: center;
            background-size: 90%; /* 絵柄を少し大きく */
        }

        /* 赤枠：中央配置 (Top: 180px = 3コマ分降りたところからスタート) */
        .target-box { 
            position: absolute; 
            top: 180px; 
            left: 0; 
            width: 100%; 
            height: 180px; /* 3コマ分 */
            border: 4px solid #ff0000; 
            pointer-events: none; 
            z-index: 10; 
            box-shadow: inset 0 0 15px rgba(255,0,0,0.3); 
        }

        /* リストエリア */
        .results { 
            flex: 1; 
            height: 540px; /* リールと同じ高さ */
            background: #151515; 
            border: 1px solid #333; 
            overflow-y: auto; 
            border-radius: 6px; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* 行スタイル：高さを十分に確保 */
        .res-row { 
            display: flex; 
            border-bottom: 1px solid #2a2a2a; 
            min-height: 38px; /* 押しやすい高さ */
            align-items: center; 
            padding: 0 8px; 
            font-family: monospace; 
        }
        
        .res-name { 
            width: 90px; 
            font-size: 13px; /* 文字サイズUP */
            font-weight: bold; 
            flex-shrink: 0; 
            line-height: 1.2; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: #ccc;
        }
        
        .res-data { 
            flex: 1; 
            text-align: right; 
            font-size: 15px; /* 数字サイズUP */
            color: #fff; 
            word-break: break-all; 
            letter-spacing: -1px; /* 数字の間隔調整 */
        }
        
        /* スベリ表示：間隔を詰めて視認性確保 */
        .res-slip { 
            display: inline-block; 
            padding: 2px 4px; 
            margin: 0; 
            background: #333; 
            border-radius: 3px; 
            font-weight: bold; 
            color: #fff;
            min-width: 20px;
            text-align: center;
            border: 1px solid #555;
            font-size: 14px;
        }

        .res-row:nth-child(odd) { background: rgba(255,255,255,0.03); }
        
        /* 色分け定義（重要） */
        .f-bell { border-left: 5px solid #ffeb3b; color: #ffeb3b; }
        .f-bell .res-name { color: #ffeb3b; }
        
        .f-suika { border-left: 5px solid #00e676; color: #00e676; }
        .f-suika .res-name { color: #00e676; }
        
        .f-cher { border-left: 5px solid #ff4081; color: #ff4081; }
        .f-cher .res-name { color: #ff4081; }
        
        .f-rep { border-left: 5px solid #80d8ff; color: #80d8ff; }
        .f-rep .res-name { color: #80d8ff; }
        
        .f-hazure { border-left: 5px solid #888; color: #aaa; }
        
        .f-tok { border-left: 5px solid #e040fb; color: #e040fb; }
        .f-tok .res-name { color: #e040fb; }

        #error-log { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:red; z-index:9999; padding:20px; white-space: pre-wrap; font-family:monospace; }
    </style>
</head>
<body>
    <div id="error-log"></div>
    <div class="controls">
        <div class="tab-group">
            <div id="t-left" class="stop-tab tab active" onclick="app.setStop('left')">左リール</div>
            <div id="t-middle" class="stop-tab tab" onclick="app.setStop('middle')">中リール</div>
            <div id="t-right" class="stop-tab tab" onclick="app.setStop('right')">右リール</div>
        </div>
        <div class="tab-group">
            <div id="s-bonus_unestablished" class="state-tab tab active" onclick="app.setState('bonus_unestablished')">ボーナス未成立</div>
            <div id="s-x_big_established" class="state-tab tab" onclick="app.setState('x_big_established')">Ｘビッグ成立</div>
            <div id="s-seven_big_established" class="state-tab tab" onclick="app.setState('seven_big_established')">７ビッグ成立</div>
            <div id="s-reg_bonus_established" class="state-tab tab" onclick="app.setState('reg_bonus_established')">Regボーナス成立</div>
        </div>
    </div>

    <div class="workspace">
        <div id="touch-area" class="reel-container">
            <div class="target-box"></div>
            <div id="reel-strip" class="reel-strip"></div>
        </div>
        <div class="results" id="result-list"></div>
    </div>

<script>
window.onerror = function(msg, url, line) {
    const log = document.getElementById('error-log');
    log.style.display = 'block';
    log.innerText = `System Error:\n${msg}\nLine: ${line}`;
};

// ピンチイン・アウト防止
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });

const NAME_MAP = {
    "左リール": "left", "left": "left",
    "中リール": "middle", "middle": "middle",
    "右リール": "right", "right": "right",
    "ボーナス未成立": "bonus_unestablished", "bonus_unestablished": "bonus_unestablished",
    "Ｘビッグ成立": "x_big_established", "x_big_established": "x_big_established",
    "７ビッグ成立": "seven_big_established", "seven_big_established": "seven_big_established",
    "Regボーナス成立": "reg_bonus_established", "reg_bonus_established": "reg_bonus_established",
};

const REEL_ASSETS = { left: "reel1.png", middle: "reel2.png", right: "reel3.png" };

const FLAG_INFO = {
    hazure: { n: "ハズレ", c: "hazure" }, replay_normal: { n: "通常リプレイ", c: "rep" }, replay_jac: { n: "ＪＡＣリプレイ", c: "rep" }, replay_rt: { n: "ＲＴリプレイ", c: "rep" },
    bell_a: { n: "ベルＡ", c: "bell" }, bell_b: { n: "ベルＢ", c: "bell" }, watermelon_a: { n: "スイカＡ", c: "suika" }, watermelon_b: { n: "スイカＢ", c: "suika" },
    cherry_a: { n: "チェリーＡ", c: "cher" }, cherry_b: { n: "チェリーＢ", c: "cher" },
    special_a: { n: "特殊役Ａ", c: "tok" }, special_b: { n: "特殊役Ｂ", c: "tok" }, special_c: { n: "特殊役Ｃ", c: "tok" }, special_d: { n: "特殊役Ｄ", c: "tok" }, special_e: { n: "特殊役Ｅ", c: "tok" }
};

const REEL_SYMBOLS = {
    left: ["Rep","Cher","X","Bell","Sui","Rep","Bell","Sui","Seven","Bell","Rep","Cher","Bar","Bell","Sui","Rep","X","X","X","Sui","Bell"],
    middle: ["Bell","Cher","Rep","Bell","Cher","Sui","Seven","Sui","Bell","Bar","Cher","Rep","Bell","Cher","X","Rep","Bell","Cher","Sui","Cher","Rep"],
    right: ["Cher","Bell","Sui","Rep","Cher","Seven","Bell","Sui","Rep","Cher","Bell","Rep","Bar","Cher","Bell","Sui","Rep","X","Bell","Sui","Rep"]
};

const SYMBOL_DISPLAY_MAP = { "Rep": "リプレイ", "Cher": "チェリー", "X": "Ｘ", "Bell": "ベル", "Sui": "スイカ", "Seven": "７", "Bar": "Reg" };

class ReverseAuditor {
    constructor() { this.db = { left: {}, middle: {}, right: {} }; }
    register(reelName, stateName, flagKey, data) {
        const reel = NAME_MAP[reelName];
        const state = NAME_MAP[stateName];
        if (!reel || !this.db[reel]) return;
        if (!this.db[reel][state]) this.db[reel][state] = {};
        const store = new Array(22).fill(null); 
        if (typeof data === 'object') {
            Object.keys(data).forEach(key => {
                const num = parseInt(key, 10);
                if (num >= 1 && num <= 21) {
                    store[num] = (data[key] === 'n' || data[key] === null) ? null : data[key];
                }
            });
        }
        this.db[reel][state][flagKey] = store;
    }
    audit(reel, state, currentStopNum) {
        const table = this.db[reel][state];
        if (!table) return [];
        const results = [];
        Object.keys(table).forEach(flagKey => {
            const slips = table[flagKey];
            const found = [];
            for (let P = 1; P <= 21; P++) {
                const L = slips[P];
                if (L === null) continue;
                const calculatedStop = (P + L - 1) % 21 + 1;
                if (calculatedStop === currentStopNum) found.push({ pushNum: P, slip: L });
            }
            if (found.length > 0) {
                found.sort((a, b) => {
                    if (b.slip !== a.slip) return b.slip - a.slip; 
                    return b.pushNum - a.pushNum; 
                });
                results.push({ key: flagKey, info: FLAG_INFO[flagKey] || {n: flagKey, c: 'hazure'}, matches: found });
            }
        });
        return results;
    }
}
const Engine = new ReverseAuditor();

const parseAndRegister = (reel, state, rawText) => {
    const lines = rawText.trim().split('\n');
    const flagOrder = ["hazure", "replay_normal", "replay_jac", "replay_rt", "bell_a", "bell_b", "watermelon_a", "watermelon_b", "cherry_a", "cherry_b", "special_a", "special_b", "special_c", "special_d", "special_e"];
    const dataStore = {};
    flagOrder.forEach(f => dataStore[f] = {});
    lines.forEach(line => {
        const cols = line.trim().split(/\s+/);
        if (cols.length < 2) return;
        const pushNum = parseInt(cols[0], 10);
        if (isNaN(pushNum) || pushNum < 1 || pushNum > 21) return;
        flagOrder.forEach((flag, idx) => {
            const val = cols[idx + 1];
            dataStore[flag][pushNum] = (!val || val.toLowerCase() === "null") ? null : parseInt(val, 10);
        });
    });
    flagOrder.forEach(flag => Engine.register(reel, state, flag, dataStore[flag]));
};

// ==========================================
// DATA INJECTION (ALL REBUILT & CORRECT)
// ==========================================
parseAndRegister("左リール", "ボーナス未成立", `
21	2	0	1	0	1	1	2	2	4	4	null	null	null	null	null
20	2	1	2	1	1	1	1	1	0	0	null	null	null	null	null
19	4	2	0	2	3	3	4	4	1	1	null	null	null	null	null
18	4	3	1	3	3	3	3	3	0	0	null	null	null	null	null
17	0	4	2	4	4	4	0	0	1	1	null	null	null	null	null
16	1	0	3	0	0	0	0	0	2	2	null	null	null	null	null
15	1	1	0	0	2	2	1	1	3	3	null	null	null	null	null
14	1	0	0	1	1	1	1	1	4	4	null	null	null	null	null
13	0	1	2	1	1	1	4	4	0	0	null	null	null	null	null
12	1	2	2	2	1	1	0	0	1	1	null	null	null	null	null
11	0	0	4	0	1	1	2	2	2	2	null	null	null	null	null
10	1	1	2	1	1	1	2	2	0	0	null	null	null	null	null
9	2	2	3	2	3	3	4	4	1	1	null	null	null	null	null
8	3	3	4	3	3	3	4	4	0	0	null	null	null	null	null
7	0	4	2	4	4	4	0	0	1	1	null	null	null	null	null
6	1	0	3	0	1	1	1	1	2	2	null	null	null	null	null
5	0	1	0	0	2	2	1	1	3	3	null	null	null	null	null
4	1	0	1	1	3	3	2	2	4	4	null	null	null	null	null
3	2	1	1	1	1	1	2	2	1	1	null	null	null	null	null
2	0	2	3	2	2	2	3	3	2	2	null	null	null	null	null
1	0	3	3	3	0	0	1	1	3	3	null	null	null	null	null
`);
parseAndRegister("左リール", "Ｘビッグ成立", `
21	2	0	0	0	1	1	2	2	4	4	2	2	2	1	2
20	2	1	2	1	1	1	3	3	0	0	2	2	2	4	2
19	4	2	2	2	3	2	4	4	1	1	4	4	4	3	4
18	4	3	4	3	3	4	4	4	0	0	4	4	4	4	4
17	0	4	0	4	4	0	0	0	1	1	0	0	0	0	0
16	1	0	0	0	0	1	1	1	2	2	1	1	1	1	1
15	2	1	1	1	2	1	2	2	3	3	2	2	2	2	2
14	3	2	1	0	1	2	3	3	4	4	3	3	3	3	3
13	4	3	0	1	1	4	4	4	4	4	4	4	4	4	4
12	1	4	0	2	1	0	0	0	1	1	1	1	1	2	1
11	0	0	2	0	1	2	2	2	2	2	2	0	2	2	0
10	2	4	1	1	1	4	2	2	0	0	2	2	2	2	2
9	2	2	4	2	3	2	4	4	1	1	4	2	4	2	2
8	3	3	3	3	3	4	4	4	0	0	4	3	4	4	3
7	0	4	0	4	4	0	0	0	1	1	0	0	0	0	0
6	1	0	1	0	1	1	1	1	2	2	1	1	1	0	1
5	0	1	1	1	2	2	0	0	3	3	0	0	0	0	0
4	0	0	2	0	3	3	1	1	4	4	0	0	0	1	0
3	0	3	4	1	1	4	2	2	1	1	0	0	0	1	0
2	0	2	0	2	2	2	3	3	2	2	0	0	0	3	0
1	0	3	1	3	0	1	1	1	3	3	0	0	0	3	0
`);
parseAndRegister("左リール", "７ビッグ成立", `
21	1	0	1	0	1	2	2	2	4	4	2	1	0	2	2
20	1	1	1	1	1	2	1	1	0	0	1	3	1	3	3
19	3	2	4	2	3	4	4	4	1	1	4	3	3	3	3
18	3	3	1	3	3	4	3	3	0	0	3	4	3	4	4
17	0	4	4	4	4	0	0	0	1	1	0	0	0	0	0
16	1	0	1	0	0	1	0	0	2	2	0	1	1	1	1
15	0	1	4	1	2	1	1	1	3	3	1	0	2	2	2
14	0	0	2	0	1	1	1	1	4	4	1	0	1	1	1
13	0	1	1	1	1	0	0	0	0	0	0	0	0	0	0
12	1	2	0	2	1	1	0	0	1	1	0	1	0	0	0
11	1	0	1	0	1	0	2	2	2	2	2	1	1	1	1
10	1	1	2	1	1	1	2	2	0	0	2	1	2	2	2
9	3	2	0	2	3	2	4	4	1	1	4	3	3	3	3
8	3	3	4	3	3	3	4	4	0	0	4	3	4	4	4
7	4	4	4	4	4	0	0	0	1	1	0	4	0	4	4
6	1	0	0	0	1	1	1	1	2	2	1	1	1	1	1
5	2	1	4	1	2	0	1	1	3	3	1	0	2	0	0
4	3	0	1	0	3	1	2	2	4	4	2	1	1	1	1
3	4	1	1	1	1	2	2	2	1	1	2	2	2	2	2
2	1	2	3	2	2	0	3	3	2	2	3	1	3	3	3
1	1	3	0	3	0	0	1	1	3	3	1	1	0	0	0
`);
parseAndRegister("左リール", "Regボーナス成立", `
21	1	0	0	0	1	1	2	2	4	4	0	2	0	2	2
20	1	1	1	1	1	1	1	1	0	0	1	3	1	2	3
19	3	2	2	2	3	2	4	4	1	1	3	3	3	4	3
18	3	3	3	3	3	4	3	3	0	0	3	4	3	4	4
17	0	4	4	4	4	0	0	0	1	1	0	0	0	0	0
16	1	0	0	0	0	1	0	0	2	2	1	1	1	1	1
15	0	1	1	1	2	1	1	1	3	3	2	2	2	2	2
14	0	0	0	0	1	2	1	1	4	4	1	1	1	3	1
13	0	1	1	1	1	4	0	0	0	0	0	0	0	0	0
12	1	2	2	2	1	0	0	0	1	1	0	0	0	1	0
11	1	0	0	0	1	0	2	2	2	2	1	1	1	0	1
10	1	1	1	1	1	4	2	2	0	0	2	2	2	2	2
9	3	2	2	2	3	2	4	4	1	1	3	3	3	3	3
8	3	3	3	3	3	3	4	4	0	0	4	4	4	3	4
7	0	4	4	4	4	0	0	0	1	1	0	0	0	0	0
6	1	0	0	0	1	1	1	1	2	2	1	1	1	1	1
5	2	1	1	1	2	2	2	2	3	3	2	0	2	0	0
4	3	0	0	0	3	3	3	3	4	4	3	1	3	0	1
3	4	1	1	1	1	4	4	4	4	4	4	2	4	0	2
2	1	2	2	2	2	2	3	3	2	2	3	3	3	3	3
1	1	3	3	3	0	1	1	1	3	3	1	1	0	0	0
`);
parseAndRegister("中リール", "ボーナス未成立", `
21	3	1	1	1	0	0	2	2	2	2	nul	nul	nul	nul	nul
20	2	1	1	1	0	0	2	2	2	2	nul	nul	nul	nul	nul
19	0	2	2	2	1	1	3	3	0	0	nul	nul	nul	nul	nul
18	1	0	0	0	2	2	4	4	1	1	nul	nul	nul	nul	nul
17	2	1	1	1	0	0	2	2	2	2	nul	nul	nul	nul	nul
16	0	2	2	2	1	1	0	0	0	0	nul	nul	nul	nul	nul
15	1	3	3	3	2	2	0	0	1	1	nul	nul	nul	nul	nul
14	0	4	4	4	3	3	0	0	0	0	nul	nul	nul	nul	nul
13	3	0	0	0	4	4	2	2	1	1	nul	nul	nul	nul	nul
12	2	1	1	1	0	0	2	2	2	2	nul	nul	nul	nul	nul
11	3	2	2	2	1	1	4	4	3	3	nul	nul	nul	nul	nul
10	1	3	3	3	2	2	4	4	0	0	nul	nul	nul	nul	nul
9	1	0	0	0	3	3	1	1	1	1	nul	nul	nul	nul	nul
8	3	1	1	1	0	0	2	2	2	2	nul	nul	nul	nul	nul
7	3	2	2	2	1	1	0	0	3	3	nul	nul	nul	nul	nul
6	1	3	3	3	2	2	0	0	4	4	nul	nul	nul	nul	nul
5	1	0	0	0	3	3	2	2	1	1	nul	nul	nul	nul	nul
4	3	1	1	1	0	0	3	3	2	2	nul	nul	nul	nul	nul
3	3	2	2	2	1	1	0	0	3	3	nul	nul	nul	nul	nul
2	1	3	3	3	2	2	1	1	4	4	nul	nul	nul	nul	nul
1	0	4	4	4	3	3	2	2	0	0	nul	nul	nul	nul	nul
`);
parseAndRegister("中リール", "Ｘビッグ成立", `
21	0	1	1	1	0	0	0	0	2	2	2	2	2	2	2
20	4	2	2	2	1	1	4	4	3	3	4	2	2	3	0
19	2	3	3	3	2	2	4	4	0	0	4	3	3	3	1
18	1	0	0	0	3	3	1	1	1	1	2	4	4	4	2
17	0	1	1	1	0	0	0	0	2	2	2	2	2	2	2
16	0	2	2	2	1	1	0	0	3	3	0	0	0	0	0
15	0	3	3	3	2	2	0	0	4	4	0	0	0	0	0
14	1	0	0	0	3	3	1	1	1	1	0	0	0	2	0
13	2	1	1	1	0	0	2	2	2	2	3	3	3	1	3
12	3	2	2	2	1	1	0	0	3	3	4	4	4	2	4
11	4	3	3	3	2	2	0	0	4	4	4	4	4	3	4
10	4	4	4	4	3	3	1	1	0	0	4	4	4	4	4
9	1	0	0	0	4	4	1	1	1	1	1	1	1	3	1
8	0	1	1	1	0	0	2	2	2	2	2	2	2	1	2
7	3	2	2	2	1	1	3	3	0	0	4	0	4	0	0
6	2	0	0	0	2	2	4	4	1	1	4	0	4	1	0
5	1	1	1	1	0	0	1	1	2	2	2	2	2	1	2
4	1	2	2	2	1	1	0	0	0	0	0	0	0	0	0
3	2	3	3	3	2	2	0	0	1	1	1	0	1	0	1
2	1	4	4	4	3	3	1	1	0	0	0	0	0	0	0
1	4	0	0	0	4	4	2	2	1	1	3	1	3	1	3
`);
parseAndRegister("中リール", "７ビッグ成立", `
21	2	0	0	0	4	4	1	1	1	1	1	0	1	1	1
20	3	1	1	1	0	0	2	2	2	2	2	4	2	2	2
19	0	2	2	2	1	1	3	3	0	0	4	2	4	0	0
18	1	0	0	0	2	2	4	4	1	1	4	1	4	0	0
17	2	1	1	1	0	0	2	2	2	2	2	1	2	2	2
16	3	2	2	2	1	1	0	0	3	3	0	0	0	4	0
15	0	3	3	3	2	2	0	0	4	4	0	1	0	4	0
14	0	4	4	4	3	3	0	0	0	0	0	0	0	0	0
13	2	0	0	0	4	4	2	2	1	1	1	0	1	1	1
12	2	1	1	1	0	0	2	2	2	2	2	2	2	2	2
11	3	2	2	2	1	1	4	4	3	3	4	2	2	2	2
10	4	3	3	3	2	2	4	4	0	0	4	3	3	3	3
9	4	0	0	0	3	3	4	4	1	1	4	4	4	4	4
8	2	1	1	1	0	0	2	2	2	2	2	1	2	2	2
7	3	2	2	2	1	1	0	0	3	3	0	0	0	4	0
6	4	3	3	3	2	2	0	0	4	4	0	1	0	4	0
5	2	0	0	0	3	3	2	2	1	1	0	0	0	0	0
4	3	1	1	1	0	0	3	3	2	2	3	3	3	3	3
3	4	2	2	2	1	1	0	0	3	3	4	2	4	4	4
2	0	3	3	3	2	2	1	1	4	4	0	3	0	0	4
1	1	4	4	4	3	3	2	2	0	0	4	4	4	4	4
`);
parseAndRegister("中リール", "Regボーナス成立", `
21	1	0	0	0	4	4	1	1	1	1	1	1	1	1	1
20	1	1	1	1	0	0	3	3	2	2	2	2	2	2	2
19	0	2	2	2	1	1	4	4	0	0	3	3	3	3	3
18	1	0	0	0	2	2	4	4	1	1	4	0	4	0	0
17	2	1	1	1	0	0	2	2	2	2	1	1	1	1	1
16	3	2	2	2	1	1	0	0	0	0	0	2	0	2	2
15	0	3	3	3	2	2	0	0	0	0	0	0	0	0	0
14	0	4	4	4	3	3	0	0	0	0	1	1	1	1	1
13	1	0	0	0	4	4	1	1	1	1	1	1	1	1	1
12	2	1	1	1	0	0	2	2	2	2	2	2	2	2	2
11	3	2	2	2	1	1	3	3	3	3	4	2	2	2	2
10	0	3	3	3	2	2	4	4	0	0	4	3	3	3	3
9	1	0	0	0	3	3	1	1	1	1	4	4	4	4	4
8	2	1	1	1	0	0	2	2	2	2	2	2	2	2	2
7	3	2	2	2	1	1	3	3	3	3	0	0	0	3	0
6	4	3	3	3	2	2	4	4	4	4	1	1	1	4	1
5	2	0	0	0	3	3	2	2	1	1	0	0	0	0	0
4	1	1	1	1	0	0	1	1	2	2	3	3	3	3	3
3	4	2	2	2	1	1	0	0	3	3	2	2	2	2	2
2	3	3	3	3	2	2	1	1	4	4	3	3	3	3	3
1	0	4	4	4	3	3	0	0	0	0	0	4	0	0	4
`);
parseAndRegister("右リール", "ボーナス未成立", `
21	0	3	0	3	2	2	0	0	2	2	Null	Null	Null	Null	Null
20	0	0	1	0	3	3	3	3	3	3	Null	Null	Null	Null	Null
19	2	1	2	1	0	0	0	0	0	0	Null	Null	Null	Null	Null
18	2	2	3	2	1	1	3	3	1	1	Null	Null	Null	Null	Null
17	0	3	0	3	2	2	2	2	2	2	Null	Null	Null	Null	Null
16	1	0	1	0	3	3	1	1	3	3	Null	Null	Null	Null	Null
15	2	1	2	1	4	4	4	4	2	2	Null	Null	Null	Null	Null
14	3	2	3	2	0	0	0	0	3	3	Null	Null	Null	Null	Null
13	4	3	4	3	1	1	4	4	4	4	Null	Null	Null	Null	Null
12	0	4	0	4	2	2	0	0	0	0	Null	Null	Null	Null	Null
11	1	0	1	0	3	3	3	3	1	1	Null	Null	Null	Null	Null
10	1	1	2	1	0	0	4	4	2	2	Null	Null	Null	Null	Null
9	3	2	0	2	1	1	0	0	3	3	Null	Null	Null	Null	Null
8	3	0	1	0	2	2	4	4	0	0	Null	Null	Null	Null	Null
7	0	1	2	1	3	3	0	0	1	1	Null	Null	Null	Null	Null
6	1	2	3	2	0	0	0	0	0	0	Null	Null	Null	Null	Null
5	2	3	4	3	1	1	2	2	1	1	Null	Null	Null	Null	Null
4	0	4	0	4	2	2	2	2	2	2	Null	Null	Null	Null	Null
3	1	0	1	0	3	3	4	4	3	3	Null	Null	Null	Null	Null
2	2	1	2	1	0	0	2	2	2	2	Null	Null	Null	Null	Null
1	3	2	3	2	1	1	1	1	3	3	Null	Null	Null	Null	Null
`);
parseAndRegister("右リール", "Ｘビッグ成立", `
21	2	3	0	3	2	2	2	2	2	2	2	2	2	2	2
20	3	0	1	0	3	3	3	3	3	3	3	3	3	3	3
19	4	1	2	1	0	0	4	4	0	0	4	4	4	4	4
18	3	2	3	2	1	1	3	3	1	1	3	3	3	0	3
17	2	3	0	3	2	2	2	2	2	2	2	2	2	1	2
16	1	0	1	0	3	3	1	1	3	3	0	0	0	2	0
15	4	1	2	1	4	4	4	4	2	2	1	1	1	3	1
14	3	2	3	2	0	0	3	3	3	3	0	0	0	4	0
13	1	3	4	3	1	1	1	1	4	4	3	3	3	0	3
12	0	4	0	4	2	2	0	0	0	0	2	2	2	0	2
11	3	0	1	0	3	3	3	3	1	1	3	3	3	1	3
10	0	1	2	1	0	0	2	2	2	2	4	0	0	0	4
9	0	2	0	2	1	1	0	0	3	3	2	2	2	1	2
8	2	0	1	0	2	2	4	4	0	0	2	2	2	2	2
7	2	1	2	1	3	3	2	2	1	1	0	4	4	3	0
6	0	2	3	2	0	0	0	0	0	0	0	4	4	4	0
5	1	3	4	3	1	1	1	1	1	1	2	2	2	0	2
4	0	4	0	4	2	2	0	0	2	2	0	0	0	0	0
3	1	0	1	0	3	3	1	1	3	3	1	1	1	1	1
2	0	1	2	1	0	0	0	0	2	2	2	2	2	2	2
1	3	2	3	2	1	1	3	3	3	3	1	1	1	1	1
`);
parseAndRegister("右リール", "７ビッグ成立", `
21	0	3	0	3	2	2	0	0	2	2	2	1	2	2	2
20	1	0	1	0	3	3	3	3	3	3	3	2	3	3	3
19	0	1	2	1	0	0	0	0	0	0	0	2	0	0	0
18	3	2	3	2	1	1	3	3	1	1	3	3	3	3	3
17	2	3	0	3	2	2	2	2	2	2	2	0	2	2	2
16	0	0	1	0	3	3	1	1	3	3	0	0	0	0	0
15	0	1	2	1	4	4	4	4	1	1	1	1	1	1	1
14	0	2	3	2	0	0	0	0	0	0	0	0	0	0	0
13	3	3	4	3	1	1	1	1	1	1	3	1	1	3	3
12	2	4	0	4	2	2	2	2	2	2	2	2	2	2	2
11	3	0	1	0	3	3	3	3	3	3	3	3	3	1	3
10	4	1	2	1	0	0	4	4	4	4	4	4	4	0	4
9	0	2	0	2	1	1	0	0	3	3	2	3	2	2	2
8	1	0	1	0	2	2	4	4	0	0	2	2	2	2	2
7	0	1	2	1	3	3	0	0	1	1	0	3	4	4	0
6	3	2	3	2	0	0	0	0	0	0	0	4	4	4	0
5	2	3	4	3	1	1	2	2	1	1	2	3	2	1	2
4	3	4	0	4	2	2	2	2	2	2	3	1	3	3	3
3	4	0	1	0	3	3	4	4	3	3	2	1	2	3	3
2	2	1	2	1	0	0	2	2	2	2	0	3	2	2	2
1	1	2	3	2	1	1	1	1	3	3	1	0	1	1	1
`);
parseAndRegister("右リール", "Regボーナス成立", `
下段に押した絵柄	ハズレ	通常リプ	JACリプ	RTリプ	ベルA	ベルB	スイカA	スイカB	チェリA	チェリB	特役A	特役B	特役C	特役D	特役E
21	2	3	3	3	2	2	2	2	2	2	0	0	0	0	0
20	3	0	0	0	3	3	3	3	3	3	1	1	1	1	1
19	0	1	1	1	0	0	0	0	0	0	2	2	2	2	2
18	1	2	2	2	1	1	1	1	1	1	3	3	3	3	3
17	0	3	3	3	2	2	0	0	2	2	0	0	0	0	0
16	1	0	0	0	3	3	1	1	3	3	1	1	1	1	1
15	2	1	1	1	4	4	2	2	2	2	1	1	1	1	1
14	0	2	2	2	0	0	0	0	3	3	0	0	0	0	0
13	1	3	3	3	1	1	1	1	4	4	1	1	1	1	1
12	2	4	4	4	2	2	2	2	0	0	2	2	2	0	2
11	3	0	0	0	3	3	3	3	1	1	3	3	3	1	3
10	4	1	1	1	0	0	4	4	2	2	4	4	4	2	4
9	0	2	2	2	1	1	0	0	3	3	0	3	3	3	0
8	1	0	0	0	2	2	1	1	0	0	1	3	3	3	1
7	0	1	1	1	3	3	0	0	1	1	0	4	4	4	0
6	3	2	2	2	0	0	3	3	0	0	1	4	4	4	1
5	2	3	3	3	1	1	2	2	1	1	2	2	2	2	2
4	3	4	4	4	2	2	3	3	2	2	3	3	3	3	3
3	4	0	0	0	3	3	4	4	3	3	4	4	4	4	4
2	0	1	1	1	0	0	0	0	2	2	2	2	2	2	2
1	1	2	2	2	1	1	1	1	3	3	1	1	1	1	1
`);

const app = {
    state: { reel: 'left', flagMode: 'bonus_unestablished', stopNum: 21 },
    
    init() {
        this.renderReelStrip();
        this.attachEvents();
        setTimeout(() => this.updateView(), 100);
    },

    setStop(side) {
        this.state.reel = NAME_MAP[side] || side;
        document.querySelectorAll('.stop-tab').forEach(el => 
            el.classList.toggle('active', el.id === `t-${this.state.reel}`));
        this.renderReelStrip();
        this.updateView();
    },

    setState(mode) {
        this.state.flagMode = NAME_MAP[mode] || mode;
        document.querySelectorAll('.state-tab').forEach(el => 
            el.classList.toggle('active', el.id === `s-${this.state.flagMode}`));
        this.updateView();
    },

    updateView() {
        this.audit();
        this.updateReelPosition();
    },

    audit() {
        const list = document.getElementById('result-list');
        list.innerHTML = '';
        const results = Engine.audit(this.state.reel, this.state.flagMode, this.state.stopNum);
        
        if(results.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#555; font-size:12px;">条件に一致するフラグがありません</div>';
            return;
        }

        results.forEach(res => {
            const row = document.createElement('div');
            row.className = `res-row f-${res.info.c}`;
            
            const matchesStr = res.matches
                .map(m => `<span class="res-slip">[${m.slip}]</span>`)
                .join('');
            
            row.innerHTML = `<div class="res-name">${res.info.n}</div><div class="res-data">${matchesStr}</div>`;
            list.appendChild(row);
        });
    },

    renderReelStrip() {
        const container = document.getElementById('reel-strip');
        container.innerHTML = '';
        const symbols = REEL_SYMBOLS[this.state.reel];
        const bgImage = REEL_ASSETS[this.state.reel]; 
        
        // 3周分描画
        for(let loop=0; loop<3; loop++) {
            symbols.forEach((sym, idx) => {
                const reelNum = 21 - idx;
                const el = document.createElement('div');
                el.className = 'symbol';
                const bgSize = `100% ${21 * 60}px`;
                const bgPos = `center -${idx * 60}px`;
                
                el.innerHTML = `
                    <div class="sym-idx">${reelNum}</div>
                    <div class="sym-bg" style="background-image: url('${bgImage}'); background-size: ${bgSize}; background-position: ${bgPos}"></div>
                `;
                container.appendChild(el);
            });
        }
    },

    updateReelPosition() {
        const baseH = 21 * 60;
        const targetIdx = 21 - this.state.stopNum;
        // 9コマ表示の中央（上から4コマ目）付近にターゲットを持ってくるための補正値
        const y = -baseH - (targetIdx * 60) + 180; 
        document.getElementById('reel-strip').style.transform = `translate3d(0, ${y}px, 0)`;
    },

    attachEvents() {
        const touchArea = document.getElementById('touch-area');
        let startY = 0;
        let startNum = 0;
        let isDragging = false;
        
        const onMove = (y) => {
            if(!isDragging) return;
            const diff = startY - y;
            const moveFrame = Math.round(diff / 60);
            let nextNum = startNum - moveFrame;
            while(nextNum > 21) nextNum -= 21;
            while(nextNum < 1) nextNum += 21;
            if(this.state.stopNum !== nextNum) {
                this.state.stopNum = nextNum;
                this.updateView();
            }
        };
        
        touchArea.addEventListener('mousedown', e => { isDragging=true; startY=e.pageY; startNum=this.state.stopNum; });
        window.addEventListener('mousemove', e => onMove(e.pageY));
        window.addEventListener('mouseup', () => isDragging=false);
        
        touchArea.addEventListener('touchstart', e => { isDragging=true; startY=e.touches[0].pageY; startNum=this.state.stopNum; }, {passive:false});
        window.addEventListener('touchmove', e => { e.preventDefault(); onMove(e.touches[0].pageY); }, {passive:false});
        window.addEventListener('touchend', () => isDragging=false);
    }
};

app.init();
</script>
</body>
</html>